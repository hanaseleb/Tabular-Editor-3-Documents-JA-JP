C#スクリプトとマクロの紹介
2021-11-03
ダニエル・オティキエル
生産性の向上を謳っているソフトウェアは、ユーザーのインタラクションを自動化する手段を提供すべきです。Tabular Editorでは、まさにこの目的のためにC#スクリプトを書くことができます。タブラー・エディターのC#スクリプトを使えば、例えば以下のようなことができます。

メジャー、テーブル、計算項目などのTOMオブジェクトの作成の自動化
TOMエクスプローラで現在選択されているオブジェクトを操作する
複数のオブジェクトにプロパティを自動的に割り当てる
監査や文書化のために、様々な形式でメタデータをインポートおよびエクスポートする
スクリプトがモデルのメタデータを変更した場合、TOMエクスプローラとプロパティビューで変更内容をすぐに確認することができます。さらに、スクリプトの変更を取り消すことで、モデルのメタデータをスクリプト実行前の時点に効果的にロールバックすることができます。スクリプトの実行に失敗した場合、変更内容はデフォルトで自動的にロールバックされます。

Tabular Editor 3にはシンプルなスクリプトレコーダが搭載されており、モデルに変更を加えたときにスクリプトコードの行を少しずつ追加していくことで、使用する構文を学ぶことができます。

スクリプトはスタンドアロンファイル（.csxファイル拡張子）として保存でき、Tabular Editorユーザー間で共有することができます。さらに、スクリプトは再利用可能なマクロとして保存でき、Tabular Editorsのユーザーインターフェイスとより密接に統合されます。

スクリプトの作成
新しいC#スクリプトを作成するには、「ファイル」→「新規作成」→「C#スクリプト」のメニューオプションを使用します。なお、このオプションは、Tabular Editorにモデルがロードされていなくても利用できます。

最初のスクリプトには、以下のコードを入力します。

Info("Hello world!")と入力します。
F5を押してコードを実行します。

../images/first-script.png

コードを入力する際に間違えた場合は、構文エラーがメッセージビューに表示されます。

スクリプトをファイルとして保存するには、「ファイル」>「保存」（Ctrl+S）をクリックします。
ファイルからスクリプトを開くには、「ファイル」→「開く」→「ファイル... (Ctrl+O)を選択します。ファイルを開く」ダイアログでは、デフォルトで拡張子が .cs または .csx のファイルを探します。
スクリプトレコーダーの使用
C# スクリプトがフォーカスされている間に、C# スクリプト > スクリプトの記録のメニューオプションを使用して、タブラルエディタのスクリプトレコーダーを開始できます。スクリプトの記録中は、モデルのメタデータに変更を加えると、コードの行がスクリプトに追加されます。なお、記録を停止するまでは、スクリプトを手動で編集することはできません。

.../images/csharp-script-recorder.png

モデルのメタデータにアクセスする
現在ロードされているモデル内の特定のオブジェクトにアクセスするためには、Tabular Object Model (TOM)階層をナビゲートするC#構文を使用する必要があります。この階層のルートはModelオブジェクトです。

以下のスクリプトでは、現在ロードされているモデルの名前を出力します。モデルがロードされていない場合は、警告が表示されます。

if(Model != null)
    Info("The name of the current model is: " + Model.Name "を出力します。）
そうでなければ
    Warning("No model is currently loaded!") を表示します。
モデル・オブジェクトは、Microsoft.AnalysisServices.Tabular.Modelクラスのラッパーであり、そのプロパティのサブセットを公開し、利便性のためにいくつかのメソッドとプロパティを追加しています。

特定のメジャーにアクセスするには、そのメジャーの名前と、メジャーが存在するテーブルの名前を知る必要があります。

var myMeasure = Model.Tables["Internet Sales"].Measures["Internet Total Sales"];
myMeasure.Description = "このメジャーの式は次のとおりです。" + myMeasure.Expression;
上記スクリプトの 1 行目では、「インターネット売上」テーブルの「インターネット総売上」メジャーを検索し、そのメジャーへの参照を myMeasure 変数に格納します。

スクリプトの 2 行目では、ハードコードされた文字列とメジャーの (DAX) 式に基づいて、メジャーの説明を設定しています。

Tabular Editorは、TOM ExplorerからC#スクリプトビューにオブジェクトをドラッグ＆ドロップすることで、特定のオブジェクトを参照するコードを自動生成することができます。

.../images/generate-csharp-code.gif

Tabular EditorのほとんどのTOMオブジェクト(テーブル、カラム、メジャーなど)は、AMO/TOMクライアントライブラリを直接使用したときに利用できるのと同じプロパティのセットを公開しています。このため、マイクロソフトのAMO/TOMドキュメントを参照して、どのプロパティが利用できるかを知ることができます。例えば、以下は利用可能なメジャー・プロパティのドキュメントです。

現在のTOM Explorerの選択にアクセスする
スクリプトの再利用性を高めるためには、上記のようにモデル内のオブジェクトを直接名前で参照できるだけでは不十分な場合があります。代わりに、Tabular EditorのTOM Explorerビューで現在選択されているオブジェクトを参照すると便利です。これは、Selectedオブジェクトを使うことで可能になります。

Info("現在選択されています。Info("You have currently selected: " + Selected.Measures.Count + " measure(s).")と表示されます。
Selectedオブジェクトは、現在選択されているすべてのオブジェクト（選択された表示フォルダ内のオブジェクトを含む）のコレクションです。さらに、Selected オブジェクトには複数のプロパティが含まれており、上記の例で示した .Measures プロパティのように、特定のオブジェクト・タイプを簡単に参照することができます。一般に、これらのプロパティには複数形（.Measures）と単数形（.Measure）があります。前者は反復処理が可能なコレクションで、現在の選択範囲にその種類のオブジェクトが含まれていない場合は空になり、後者はその種類のオブジェクトが 1 つだけ選択されている場合に限り、現在選択されているオブジェクトへの参照となります。

Useful script snippetsには、Selectedオブジェクトを使って様々なタスクを実行するスクリプトの例が多数掲載されています。

ユーザーとのインタラクション
上の例では、Info(...)およびWarning(...)グローバルメソッドを使用して、さまざまなフレーバーでユーザーにメッセージを表示しました。タブラー・エディターには、これらのグローバルメソッドの他に、情報を表示したり収集したりするための拡張メソッドや、その他の様々な一般的なタスクのためのメソッドが多数用意されています。最もよく使われるものを以下に示します。

void Output(object value) - スクリプトの実行を停止し、提供されたオブジェクトの詳細情報を表示します。提供されたオブジェクトがTOMオブジェクトまたはTOMオブジェクトのコレクションの場合、すべてのプロパティの詳細が表示されます。
void SaveFile(string filePath, string content) - テキストデータをファイルに保存する便利な方法です。
string ReadFile(string filePath) - ファイルからテキストデータを読み込むのに便利です。
string ExportProperties(IEnumerable<ITabularNamedObject> objects, string properties = "...") - 複数のオブジェクトからプロパティのセットをTSV文字列としてエクスポートする便利な方法です。
void ImportProperties(string tsvData) - TSV文字列から複数のオブジェクトにプロパティをロードする便利な方法です。
string ConvertDax(dax, useSemicolons) - DAX式をUS/UKと非US/UKのロケール間で変換します。useSemicolonsが真（デフォルト）の場合、dax文字列はネイティブのUS/UK形式から非US/UK形式に変換されます。つまり、カンマ（リストの区切り文字）はセミコロンに、ピリオド（小数点の区切り文字）はカンマに変換されます。useSemicolonsがfalseに設定されている場合は、その逆になります。
void FormatDax(IEnumerable<IDaxDependantObject> objects, bool shortFormat, bool? skipSpace) - 指定されたコレクション内の全てのオブジェクトに対して DAX 式をフォーマットします。
void FormatDax(IDaxDependantObject obj) - スクリプトの実行が完了したときや、CallDaxFormatterメソッドが呼ばれたときに、DAX式のフォーマットのためにオブジェクトをキューに入れます。
void CallDaxFormatter(bool shortFormat, bool? skipSpace) - これまでにキューに入れられたオブジェクトのすべての DAX 式をフォーマットします。
void Info(string message) - 情報としてのメッセージを表示します。
void Warning(string message) - 警告メッセージを表示します。
void Error(string message) - エラー・メッセージを表示します。
measure SelectMeasure(Measure preselect = null, string label = "...") - すべてのメジャーのリストを表示し、ユーザーに選択を促します。
T SelectObject<T>(this IEnumerable<T> objects, T preselect = null, string label = "...") ここでは、T: TabularNamedObject - 提供されたオブジェクトのリストを表示し、ユーザーに1つを選択するように促し、そのオブジェクトを返します（キャンセルボタンが押された場合は、NULLを返します）。
IList<T> SelectObjects<T>(this IEnumerable<T> objects, IEnumerable<T> preselect = null, string label = "...") ここで、T: TabularNamedObject - 提供されたオブジェクトのリストを表示し、ユーザーに任意の数のオブジェクトを選択するよう促し、選択されたオブジェクトのリスト（キャンセルボタンが押された場合はnull）を返します。
スクリプトをマクロとして保存する
よく使うスクリプトは、再利用可能なマクロとして保存することができ、Tabular Editorを起動すると常に利用可能な状態になります。さらに、マクロはTOMエクスプローラビューのコンテキストメニューに自動的に統合され、ツール＞カスタマイズ...オプションを使って、既存またはカスタムのメニューやツールバーにマクロを追加することもできます。

スクリプトをマクロとして保存するには、C#スクリプト > マクロとして保存...オプションを使用します。

.../images/save-new-macro.png

マクロの名前を指定します。例えば、"My Macros\Test "のような名前は、TOMエクスプローラのコンテキストメニューに "My Macros "サブメニューを作成し、このサブメニュー内にスクリプトを呼び出す "Test "メニューオプションがあります。

また、マクロで作成されたメニューオプションにカーソルを合わせたときに表示されるツールチップをオプションで指定することもできます。

また、マクロのコンテキストを指定する必要があります。これは、マクロがコンテキストメニューで利用できるようにするために選択する必要のあるオブジェクトの種類を指定します。

最後に、「マクロ有効条件（詳細）」で、真／偽を評価するC#式（通常はSelectedオブジェクトまたはModelオブジェクトに基づく）を指定することができます。これにより、現在の選択範囲に基づいて、マクロを有効にするかどうかをより詳細に制御することができます。たとえば、次のような式があります。

Selected.Measures.Count == 1
を使用すると、ちょうど 1 つのメジャーが選択されたときにのみマクロを有効にすることができます。

マクロの管理
以前に保存したすべてのマクロは [マクロ] ビューに表示されます。このビューを表示するには、[表示]、[マクロ] の順に選択します。このビューでは、以下のことができます。

マクロの名前を変更する（［名前］列にカーソルを置いて新しい名前を入力するだけ）。
マクロの削除。マクロを選択して、マクロのリストの上にある赤い「X」ボタンをクリックします。
マクロを編集する。リストの中のマクロをダブルクリックします（リストの「Id」列をダブルクリックします）。すると、マクロが新しいC#スクリプトビューで開かれ、コードの変更が可能になります。Ctrl+Sを押して、コードの変更を保存します。他のマクロのプロパティ（ツールチップ、マクロのコンテキストなど）を編集する必要がある場合は、「C#スクリプト」→「マクロの編集...」メニューオプションを使用します。
次のステップ
ニーズに合わせてTabular Editor 3をパーソナライズおよび設定する
タブラー・エディター3で生産性を高める
参考文献
C#スクリプト
便利なスクリプトスニペット